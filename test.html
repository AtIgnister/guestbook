<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>
        let captchaKey = '';

        async function loadCaptcha() {
            const res = await fetch('http://127.0.0.1:8001/captcha/api/default');
            const data = await res.json();
            captchaKey = data.key;
            document.getElementById('captchaImage').src = data.img;
            document.getElementById('captchaKey').value = captchaKey;
        }

        async function loadEntries(entries) {
            const container = document.getElementById('guestbooks___guestbook-messages-container');
            container.innerHTML = '';
            entries.forEach(entry => {
                container.innerHTML += `
                    <div class="k-comment">
                        <p class="k-name">${entry.name}</p>
                        <p class="c-comment">${entry.comment}</p>
                    </div>
                `;
            });
        }
    </script>


    <!-- Guestbook Script -->
    <script defer>
    const id = '7ddeb8e7-c845-4e81-9410-c129c4f17aa7';
    const submitAction = `http://127.0.0.1:8001/embed/entries/${id}/store`;

    fetch(`http://127.0.0.1:8001/guestbooks/${id}/export/json/raw`)
    .then(res => res.json())
    .then(data => initGuestbook(data));

    function initGuestbook(data) {
        loadEntries(data.guestbooks[id].entries);
        loadCaptcha();

        const form = document.querySelector('#guestbooks___guestbook-form');
        if (!form) return;

        form.action = submitAction;

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const formData = new FormData(form);

        const res = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const json = await res.json();

        if (json.success) {
            alert(json.message);
            form.reset();
            loadCaptcha();

            // Refresh guestbook entries
            const entriesRes = await fetch(`http://127.0.0.1:8001/guestbooks/${id}/export/json/raw`);
            const entriesData = await entriesRes.json();
            loadEntries(entriesData.guestbooks[id].entries);
        } else {
            alert(json.message);
            loadCaptcha();
        }
    });

    }

    function submit() {}
    </script>

    <h1>sign my guestbook!</h1>

    <hr>

    <!-- Guestbook Form -->
    <div id="guestbooks___guestbook-form-container">
    <form id="guestbooks___guestbook-form" 
            action="https://guestbooks.meadow.cafe/guestbook/453/submit" 
            method="post">
        
    <div class="guestbooks___input-container">
        <input type="text" 
                id="name" 
                name="name" 
                placeholder="name" 
                required>
        </div>
        
    <div class="guestbooks___input-container">
        <input type="url" 
                id="website" 
                name="website" 
                placeholder="website (optional)">
        </div>
        
    <div id="guestbooks___challenge-answer-container"></div>
        
    <div class="guestbooks___input-container">
        <textarea id="text" 
                    name="comment" 
                    placeholder="leave your message here..." 
                    rows="4"
                    style="width: 100%; box-sizing: border-box; resize: vertical;"
                    required></textarea>
    </div>
    
    <div id="k-captcha">
        <img id="captchaImage" alt="captcha" style="width: 200px; height: 80px; object-fit: contain; display: block; margin-bottom: 0.5rem;">
        <label for="captcha">Captcha</label>
        <input type="text" name="captcha" placeholder="Enter captcha" required>

        <div class="flex items-center gap-2">
            <button type="button" onclick="loadCaptcha()">â†»</button>
            <input type="hidden" name="key" id="captchaKey">
        </div>
    </div>

    <button type="submit">submit</button>
    <div id="guestbooks___error-message"></div>
    </form>
    </div>

    <!-- Attribution (optional but appreciated!) -->
    <div id="guestbooks___guestbook-made-with" style="text-align: right; margin-top: 10px;">
    <small>powered by <a href="https://guestbooks.meadow.cafe" target="_blank">guestbooks</a></small>
    </div>

    <!-- Messages Section -->
    <hr>
    <h3 id="guestbooks___guestbook-messages-header">messages</h3>
    <div id="guestbooks___guestbook-messages-container"></div>
</body>
</html>